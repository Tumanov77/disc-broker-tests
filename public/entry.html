<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестирование брокеров по продажам недвижимости</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .header {
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .header .description {
            color: #888;
            font-size: 1em;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-data {
            color: #333;
            font-weight: 500;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .user-buttons {
            display: flex;
            align-items: center;
        }

        .update-timestamp {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: white;
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        .tests-section {
            margin: 40px 0;
        }

        .tests-section h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .test-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .test-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }

        .test-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .test-card.disabled:hover {
            transform: none;
            border-color: transparent;
            box-shadow: none;
        }

        .step-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .step-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .step-description {
            color: #666;
            font-size: 1em;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .step-status {
            margin-bottom: 20px;
        }

        .status-coming-soon {
            background: #ff9800;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .test-status {
            color: #ff9800;
            font-weight: 600;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .test-card h4 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .time-info {
            color: #888;
            font-size: 0.9em;
            font-weight: normal;
        }

        .unlock-section {
            margin: 30px 0;
        }

        .unlock-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.2);
        }

        .unlock-card h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .unlock-card p {
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .unlock-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .unlock-btn:hover {
            transform: translateY(-2px);
        }

        .test-card h3 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .test-card .test-description {
            color: #666;
            font-size: 1em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .test-card .test-details {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .test-link {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .test-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .info-section {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 4px solid #2196f3;
        }

        .info-section h3 {
            color: #1976d2;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .info-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .info-section .highlight {
            color: #1976d2;
            font-weight: 600;
        }

        .footer {
            margin-top: 30px;
            color: #888;
            font-size: 0.9em;
        }

        .progress-container {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-info span {
            font-weight: 600;
            font-size: 1.1em;
        }

        #currentStage {
            color: #1976d2;
        }

        #stageCounter {
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 25%;
        }

        .test-card.completed {
            background: #d4edda;
            border-color: #28a745;
            cursor: default;
        }

        .test-card.completed h4 {
            color: #155724;
        }

        .test-card.completed .test-link {
            color: #155724;
            cursor: default;
            text-decoration: none;
        }

        .test-card.completed .test-link:hover {
            text-decoration: none;
        }

        .test-card.completed::after {
            content: "✓ Пройден";
            position: absolute;
            top: 15px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header .subtitle {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-data">
                    <span id="userName"></span> (<span id="userTelegram"></span>)
                </div>
                <div class="user-buttons">
                    <button class="logout-btn" onclick="clearAllData()" style="margin-right: 10px; background: #dc3545;">Очистить данные</button>
                    <button class="logout-btn" onclick="logout()">Выйти</button>
                </div>
            </div>
            
            <h1>🏢 Первый шаг в команду Tumanov Group</h1>
            <div class="description">
                Мы используем тестирование, чтобы в команду попадали только сильные, честные и продуктивные люди.<br>
                Каждый этап — фильтр: не прошёл → процесс завершается, прошёл → идёшь дальше.
            </div>
            
            <!-- Прогресс-бар (скрыт до этапа 3) -->
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-info">
                    <span id="currentStage">Этап 3</span>
                    <span id="stageCounter">3 из 4</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div class="tests-section">
            
            
            <!-- Этап 1: Первичный вход -->
            <div class="step-section">
                
                <div class="step-description">
                    Быстрая проверка на базовое соответствие.
                </div>
                
                <!-- DISC -->
                <div class="test-card" onclick="checkAuthAndGo('/t1')">
                    <h4>Тест 1 <span class="time-info">(5 мин)</span></h4>
                    <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/t1')">Начать тест</a>
                </div>

                <!-- Hubbard -->
                <div class="test-card" onclick="checkAuthAndGo('/t2')">
                    <h4>Тест 2 <span class="time-info">(5 мин)</span></h4>
                    <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/t2')">Начать тест</a>
                </div>

                <!-- EQ -->
                <div class="test-card" onclick="checkAuthAndGo('/t3')">
                    <h4>Тест 3 <span class="time-info">(10–15 мин)</span></h4>
                    <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/t3')">Начать тест</a>
                </div>
                
            </div>

            <!-- Этап 2: Основная оценка -->
            <div class="step-section" id="stage2" style="display: none;">
                <h3 class="step-title">✅ Этап 2. Ближе узнаём вашу личность</h3>
                
                <!-- Aptitude -->
                <div class="test-card" onclick="checkAuthAndGo('/t4')">
                    <h4>Тест 4 <span class="time-info">(15–20 мин)</span></h4>
                    <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/t4')">Начать тест</a>
                </div>

                <!-- Integrity -->
                <div class="test-card" onclick="checkAuthAndGo('/t5')">
                    <h4>Тест 5 <span class="time-info">(10–15 мин)</span></h4>
                    <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/t5')">Начать тест</a>
                </div>
            </div>

            <!-- Кнопка разблокировки Этапа 2 -->
            <div class="unlock-section" id="unlockStage2" style="display: none;">
                <div class="unlock-card">
                    <h3>🎯 Этап 2 готов к открытию!</h3>
                    <p>Вы успешно прошли Этап 1. Теперь можете перейти к более глубокому изучению вашей личности.</p>
                    <button class="unlock-btn" onclick="unlockStage(2)">Открыть Этап 2</button>
                </div>
            </div>


            <!-- Кнопка разблокировки Профильных тестов -->
            <div class="unlock-section" id="unlockRoleTests" style="display: none;">
                <div class="unlock-card">
                    <h3>🎯 Профильные тесты готовы!</h3>
                    <p>Вы успешно прошли Этап 2. Теперь проверка по вашей специальности.</p>
                    <button class="unlock-btn" onclick="unlockStage('role')">Открыть профильные тесты</button>
                </div>
            </div>

            <!-- Шаг 2: Профильные тесты -->
            <div class="step-section" id="roleSpecificTests" style="display: none;">
                <h3 class="step-title">🎯 Проверка по роли</h3>
                <div id="roleTestsContainer"></div>
            </div>

            <!-- Финальный этап: OCA -->
            <div class="step-section" id="finalStage" style="display: none;">
                <h3 class="step-title">🎯 Финальное подтверждение</h3>
                <div class="step-description">
                    Детальное изучение личности для финального отбора.
                </div>
                
                <!-- OCA -->
                <div class="test-card" onclick="checkAuthAndGo('/t6')">
                    <h4>Тест 6 <span class="time-info">(25–30 мин)</span></h4>
                    <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/t6')">Начать финальный тест</a>
                </div>
            </div>

            <!-- Кнопка разблокировки Финального этапа -->
            <div class="unlock-section" id="unlockFinalStage" style="display: none;">
                <div class="unlock-card">
                    <h3>🎯 Финальный этап готов!</h3>
                    <p>Вы успешно прошли все предыдущие этапы. Теперь финальное подтверждение вашей кандидатуры.</p>
                    <button class="unlock-btn" onclick="unlockStage('final')">Открыть финальный этап</button>
                </div>
            </div>
        </div>


        <div class="footer">
            <p>Система тестирования кандидатов Tumanov Group</p>
        </div>
    </div>

    <script>
        // Проверка логина и загрузка пользовательских данных
        document.addEventListener('DOMContentLoaded', function() {
            // Сначала проверим и очистим поврежденные данные
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const candidateData = localStorage.getItem('candidateData');
            
            console.log('Page loaded, checking data:');
            console.log('isLoggedIn:', isLoggedIn);
            console.log('candidateData:', candidateData);
            
            // Если есть флаг входа, но нет данных пользователя - очищаем всё
            if (isLoggedIn === 'true' && (!candidateData || candidateData.trim() === '')) {
                console.log('Found isLoggedIn=true but no candidateData, clearing all data');
                
                
                window.location.href = '/';
                return;
            }
            
            // Если нет флага входа, но есть данные - тоже очищаем
            if (isLoggedIn !== 'true' && candidateData) {
                console.log('Found candidateData but no isLoggedIn flag, clearing all data');
                
                
                window.location.href = '/';
                return;
            }
            
            checkLoginStatus();
            loadProgress();
            
            // Анимация появления карточек
            const cards = document.querySelectorAll('.test-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 200);
            });

            // Добавляем эффект при клике на карточку
            document.querySelectorAll('.test-card').forEach(card => {
                card.addEventListener('click', function() {
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                });
            });
        });

        function checkLoginStatus() {
            // Миграция данных со старого домена
            migrateOldDomainData();
            
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const candidateData = localStorage.getItem('candidateData');
            const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
            
            // Отладочная информация
            console.log('checkLoginStatus called');
            console.log('isLoggedIn:', isLoggedIn);
            console.log('candidateData:', candidateData);
            
            // Более строгая проверка валидности данных
            if (isLoggedIn === 'true' && candidateData && candidateData.trim() !== '') {
                try {
                    const userData = JSON.parse(candidateData);
                    
                    // Проверяем, что данные полные и корректные
                    if (!userData.fullName || !userData.telegram || !userData.role || 
                        userData.fullName.trim() === '' || userData.telegram.trim() === '' || userData.role.trim() === '') {
                        console.log('Incomplete or empty user data, clearing and redirecting');
                        
                        
                        window.location.href = '/';
                        return;
                    }
                    
                    // Проверить, не был ли кандидат отсеян по КФУ
                    if (userData.role === 'sales_manager' && progress.kfuCompleted && !progress.kfuPassed) {
                        // Показать сообщение об отсеивании и перенаправить
                        alert('Вы не прошли проверку критических факторов успеха для данной должности. Тестирование завершается.');
                        logout();
                        return;
                    }
                    
                    // Убираем отчество из имени
                    const nameParts = userData.fullName.split(' ');
                    const displayName = nameParts.length > 1 ? `${nameParts[0]} ${nameParts[1]}` : userData.fullName;
                    
                    // Убеждаемся, что элементы существуют
                    const userNameElement = document.getElementById('userName');
                    const userTelegramElement = document.getElementById('userTelegram');
                    const userInfoElement = document.getElementById('userInfo');
                    
                    if (userNameElement && userTelegramElement && userInfoElement) {
                        userNameElement.textContent = displayName;
                        userTelegramElement.textContent = userData.telegram;
                        userInfoElement.style.display = 'flex';
                        
                        console.log('User info displayed:', displayName, userData.telegram);
                    } else {
                        console.error('User info elements not found');
                    }
                    
                    // Показать тесты для выбранной роли
                    showRoleSpecificTests(userData.role);
                    
                    console.log('User successfully logged in:', displayName);
                } catch (error) {
                    console.error('Error parsing candidate data:', error);
                    // Если данные повреждены, очистить и перенаправить на вход
                    
                    
                    window.location.href = '/';
                }
            } else {
                // Если нет данных логина, перенаправить на страницу входа
                console.log('No valid login data found, redirecting to login');
                
                
                window.location.href = '/';
            }
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'sales_manager': 'Руководителя отдела продаж',
                'marketing_manager': 'Руководителя отдела маркетинга',
                'marketing_analyst': 'Маркетолога-аналитика',
                'financial_director': 'Финансового директора',
                'operational_manager': 'Операционного менеджера',
                'operational_director': 'Операционного директора',
                'assistant': 'Ассистента руководителя',
                'designer': 'Дизайнера',
                'commercial_director': 'Коммерческого директора',
                'general_director': 'Генерального директора'
            };
            return roleNames[role] || 'специалиста';
        }

        function showRoleSpecificTests(role) {
            const roleTestsContainer = document.getElementById('roleTestsContainer');
            const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
            
            if (role === 'broker') {
                roleTestsContainer.innerHTML = `
                    <div class="test-card" onclick="checkAuthAndGo('/b1')">
                        <h4>🏠 Тест 7 - настойчивость в продажах <span class="time-info">(8-12 мин)</span></h4>
                        <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/b1')">Начать тест</a>
                    </div>
                `;
            } else if (role === 'sales_manager') {
                roleTestsContainer.innerHTML = `
                    <div class="test-card" onclick="checkAuthAndGo('/kfu')">
                        <h4>👔 КФУ - Критические факторы успеха <span class="time-info">(5-7 мин)</span></h4>
                        <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/kfu')">Начать проверку КФУ</a>
                    </div>
                `;
            } else if (role === 'marketing_manager' || role === 'marketing_analyst' || role === 'financial_director' || 
                       role === 'operational_manager' || role === 'operational_director' || role === 'assistant' || 
                       role === 'designer' || role === 'commercial_director' || role === 'general_director') {
                roleTestsContainer.innerHTML = `
                    <div class="test-card disabled">
                        <h4>🎯 Профильные тесты для ${getRoleDisplayName(role)}</h4>
                        <div class="test-details">
                            Время прохождения: 20-40 минут
                        </div>
                        <div class="test-status">В разработке</div>
                    </div>
                `;
            } else if (role === 'backoffice') {
                roleTestsContainer.innerHTML = `
                    <div class="test-card disabled">
                        <h4>💼 Тесты для бэкофиса</h4>
                        <div class="test-details">
                            Время прохождения: 25-40 минут
                        </div>
                        <div class="test-status">Скоро будет доступно</div>
                    </div>
                `;
            } else if (role === 'marketing') {
                roleTestsContainer.innerHTML = `
                    <div class="test-card disabled">
                        <h4>📢 Тесты для маркетинга</h4>
                        <div class="test-details">
                            Время прохождения: 30-45 минут
                        </div>
                        <div class="test-status">Скоро будет доступно</div>
                    </div>
                `;
            } else if (role === 'other') {
                // Для "другая должность" показываем все доступные профильные тесты
                roleTestsContainer.innerHTML = `
                    <div class="test-card" onclick="checkAuthAndGo('/b1')">
                        <h4>🏠 Тест 7 - настойчивость в продажах <span class="time-info">(8-12 мин)</span></h4>
                        <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/b1')">Начать тест</a>
                    </div>
                    <div class="test-card" onclick="checkAuthAndGo('/kfu')">
                        <h4>👔 КФУ - Критические факторы успеха <span class="time-info">(5-7 мин)</span></h4>
                        <a href="javascript:void(0)" class="test-link" onclick="checkAuthAndGo('/kfu')">Начать проверку КФУ</a>
                    </div>
                `;
            }
        }

        function logout() {
            console.log('Logout called');
            // Очищаем все данные
            window.location.href = '/';
        }

        function clearAllData() {
            console.log('Clear all data called');
            
            
            alert('Все данные очищены. Перезагружаем страницу...');
            window.location.reload();
        }

        function migrateOldDomainData() {
            // Проверяем, есть ли данные с нового домена
            const hasNewData = localStorage.getItem('isLoggedIn') || localStorage.getItem('candidateData');
            
            if (!hasNewData) {
                // Пытаемся найти данные в sessionStorage (они могут сохраниться при смене домена)
                const sessionData = sessionStorage.getItem('tumanov_hr_data');
                if (sessionData) {
                    try {
                        const data = JSON.parse(sessionData);
                        localStorage.setItem('isLoggedIn', data.isLoggedIn || 'true');
                        localStorage.setItem('candidateData', JSON.stringify(data.candidateData));
                        localStorage.setItem('testProgress', JSON.stringify(data.testProgress || {}));
                        console.log('Data migrated from sessionStorage');
                    } catch (error) {
                        console.log('Failed to migrate data from sessionStorage:', error);
                    }
                }
            }
        }

        function checkAuthAndGo(url) {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const candidateData = localStorage.getItem('candidateData');
            
            console.log('checkAuthAndGo called with url:', url);
            console.log('isLoggedIn:', isLoggedIn);
            console.log('candidateData:', candidateData);
            
            // Проверяем валидность данных
            if (isLoggedIn === 'true' && candidateData) {
                try {
                    const userData = JSON.parse(candidateData);
                    if (userData.fullName && userData.telegram && userData.role) {
                        console.log('User is logged in, redirecting to:', url);
                        window.location.href = url;
                        return;
                    }
                } catch (error) {
                    console.error('Error parsing candidate data in checkAuthAndGo:', error);
                }
            }
            
            console.log('User not logged in or invalid data, redirecting to login');
            // Очищаем поврежденные данные
            window.location.href = '/';
        }

        function loadProgress() {
            const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
            const candidateData = JSON.parse(localStorage.getItem('candidateData') || '{}');
            
            // Проверить завершение Этапа 1 (все тесты Этапа 1 должны быть пройдены)
            const stage1Tests = ['test1', 'test2', 'test3']; // DISC, Hubbard, EQ
            const completedStage1Tests = stage1Tests.filter(test => progress[test + 'Completed']);
            
            if (completedStage1Tests.length === stage1Tests.length) {
                document.getElementById('unlockStage2').style.display = 'block';
                progress.stage1Completed = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
            }
            
            // Проверить разблокировку Этапа 2
            if (progress.stage2Unlocked) {
                document.getElementById('stage2').style.display = 'block';
                document.getElementById('unlockStage2').style.display = 'none';
            }
            
            // Проверить завершение Этапа 2 (тесты 4 и 5)
            const stage2Tests = ['test4', 'test5']; // Aptitude, Integrity
            const completedStage2Tests = stage2Tests.filter(test => progress[test + 'Completed']);
            
            // Если завершены тесты Этапа 2, показать кнопку разблокировки профильных тестов
            if (completedStage2Tests.length === stage2Tests.length) {
                progress.stage2Completed = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
                
                // Показать кнопку разблокировки профильных тестов только если есть тесты для роли
                const candidateData = JSON.parse(localStorage.getItem('candidateData') || '{}');
                const role = candidateData.role;
                
                if (role === 'broker' || role === 'sales_manager') {
                    document.getElementById('unlockRoleTests').style.display = 'block';
                } else {
                    // Для ролей без тестов сразу показать финальный этап
                    document.getElementById('unlockFinalStage').style.display = 'block';
                }
            }
            
            // Проверить разблокировку профильных тестов
            if (progress.roleTestsUnlocked) {
                document.getElementById('roleSpecificTests').style.display = 'block';
                document.getElementById('unlockRoleTests').style.display = 'none';
            }
            
            // Проверить завершение профильного теста в зависимости от роли
            const candidateData = JSON.parse(localStorage.getItem('candidateData') || '{}');
            const role = candidateData.role;
            
            let roleTests = [];
            if (role === 'broker') {
                roleTests = ['test7']; // SPQ для брокеров
            } else if (role === 'sales_manager') {
                roleTests = ['kfu']; // КФУ для руководителей отдела продаж
            } else if (role === 'marketing_manager' || role === 'marketing_analyst' || role === 'financial_director' || 
                       role === 'operational_manager' || role === 'operational_director' || role === 'assistant' || 
                       role === 'designer' || role === 'commercial_director' || role === 'general_director' ||
                       role === 'backoffice' || role === 'other') {
                roleTests = []; // Пока нет тестов для этих должностей
            }
            
            const completedRoleTests = roleTests.filter(test => progress[test + 'Completed']);
            
            // Если завершены профильные тесты (или их нет), показать финальный этап
            if (completedRoleTests.length === roleTests.length && roleTests.length > 0) {
                document.getElementById('unlockFinalStage').style.display = 'block';
                progress.roleTestsCompleted = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
            } else if (roleTests.length === 0 && progress.stage2Completed) {
                // Если нет профильных тестов, показать финальный этап после Этапа 2
                document.getElementById('unlockFinalStage').style.display = 'block';
                progress.roleTestsCompleted = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
            }
            
            // Проверить разблокировку финального этапа
            if (progress.finalStageUnlocked) {
                document.getElementById('finalStage').style.display = 'block';
                document.getElementById('unlockFinalStage').style.display = 'none';
            }
            
            // Обновить визуальный прогресс
            updateProgressDisplay();
        }

        function unlockStage(stageNumber) {
            const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
            
            if (stageNumber === 'final') {
                progress.finalStageUnlocked = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
                document.getElementById('finalStage').style.display = 'block';
                document.getElementById('unlockFinalStage').style.display = 'none';
            } else if (stageNumber === 'role') {
                progress.roleTestsUnlocked = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
                document.getElementById('roleSpecificTests').style.display = 'block';
                document.getElementById('unlockRoleTests').style.display = 'none';
            } else {
                progress[`stage${stageNumber}Unlocked`] = true;
                localStorage.setItem('testProgress', JSON.stringify(progress));
                
                // Обновить интерфейс
                if (stageNumber === 2) {
                    document.getElementById('stage2').style.display = 'block';
                    document.getElementById('unlockStage2').style.display = 'none';
                }
            }
        }

        // Функция для обновления прогресса (будет вызываться из тестов)
        window.updateTestProgress = function(testNumber) {
            const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
            progress[`test${testNumber}Completed`] = true;
            localStorage.setItem('testProgress', JSON.stringify(progress));
            
            // Обновить визуальный прогресс
            updateProgressDisplay();
        };

        function updateProgressDisplay() {
            const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
            const candidateData = JSON.parse(localStorage.getItem('candidateData') || '{}');
            const role = candidateData.role;
            
            // Определить общее количество этапов в зависимости от роли
            let totalStages = 4; // По умолчанию
            if (role === 'broker') {
                totalStages = 4; // Этап 1, Этап 2, Профильные, Финальный
            } else {
                totalStages = 3; // Этап 1, Этап 2, Финальный (без профильных)
            }
            
            // Определить текущий этап
            let currentStage = 1;
            let completedStages = 0;
            
            // Этап 1 завершен?
            const stage1Tests = ['test1', 'test2', 'test3'];
            const completedStage1 = stage1Tests.every(test => progress[test + 'Completed']);
            if (completedStage1) {
                completedStages++;
                currentStage = 2;
            }
            
            // Этап 2 завершен?
            const stage2Tests = ['test4', 'test5'];
            const completedStage2 = stage2Tests.every(test => progress[test + 'Completed']);
            if (completedStage2) {
                completedStages++;
                if (role === 'broker') {
                    currentStage = 3; // Профильные тесты
                } else {
                    currentStage = 3; // Финальный этап
                }
            }
            
            // Профильные тесты завершены? (только для брокеров)
            if (role === 'broker') {
                const roleTests = ['test7'];
                const completedRoleTests = roleTests.every(test => progress[test + 'Completed']);
                if (completedRoleTests) {
                    completedStages++;
                    currentStage = 4; // Финальный этап
                }
            }
            
            // Финальный этап завершен?
            if (progress.test6Completed) {
                completedStages++;
                currentStage = totalStages + 1; // Все завершено
            }
            
            // Показать прогресс-бар только с этапа 3
            if (currentStage >= 3) {
                document.getElementById('progressContainer').style.display = 'block';
                
                // Обновить отображение
                document.getElementById('currentStage').textContent = 
                    currentStage > totalStages ? 'Завершено!' : `Этап ${currentStage}`;
                document.getElementById('stageCounter').textContent = 
                    currentStage > totalStages ? `${totalStages} из ${totalStages}` : `${currentStage} из ${totalStages}`;
                
                // Обновить прогресс-бар
                const progressPercent = (completedStages / totalStages) * 100;
                document.getElementById('progressFill').style.width = `${progressPercent}%`;
            } else {
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            // Отметить завершенные тесты
            markCompletedTests(progress);
        }

        function markCompletedTests(progress) {
            // Этап 1
            const stage1Tests = [
                { test: 'test1', element: document.querySelector('[onclick*="/t1"]') },
                { test: 'test2', element: document.querySelector('[onclick*="/t2"]') },
                { test: 'test3', element: document.querySelector('[onclick*="/t3"]') }
            ];
            
            stage1Tests.forEach(({ test, element }) => {
                if (progress[test + 'Completed'] && element) {
                    element.classList.add('completed');
                    element.onclick = null; // Заблокировать повторное прохождение
                }
            });
            
            // Этап 2
            const stage2Tests = [
                { test: 'test4', element: document.querySelector('[onclick*="/t4"]') },
                { test: 'test5', element: document.querySelector('[onclick*="/t5"]') }
            ];
            
            stage2Tests.forEach(({ test, element }) => {
                if (progress[test + 'Completed'] && element) {
                    element.classList.add('completed');
                    element.onclick = null;
                }
            });
            
            // Профильные тесты
            const roleTests = [
                { test: 'test7', element: document.querySelector('[onclick*="/b1"]') }, // SPQ для брокеров
                { test: 'kfu', element: document.querySelector('[onclick*="/kfu"]') } // КФУ для руководителей
            ];
            
            roleTests.forEach(({ test, element }) => {
                if (progress[test + 'Completed'] && element) {
                    element.classList.add('completed');
                    element.onclick = null;
                }
            });
            
            // Финальный этап
            const finalTest = { test: 'test6', element: document.querySelector('[onclick*="/t6"]') };
            if (progress[finalTest.test + 'Completed'] && finalTest.element) {
                finalTest.element.classList.add('completed');
                finalTest.element.onclick = null;
            }
        }
    </script>
    
    <!-- Отметка времени обновления -->
    <div id="update-timestamp" class="update-timestamp"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timestampElement = document.getElementById('update-timestamp');
            if (timestampElement) {
                // Статичная дата последнего обновления на сервере
                timestampElement.textContent = `Последнее обновление: 26.09.2025, 04:32:20`;
            }
        });
    </script>
</body>
</html>
